path: project
name: dbt_artifacts_visuals

defaults:
  source_name: dbt_artifacts
  threads: 8
  thumbnail_mode: missing
  levels: []

cli_version: 1.0.58
includes:
  - path: "models.visivo.yml"
  - path: "./dbt-performance-overview/high-level-summary.yml"
  - path: "./dbt-performance-overview/run-level-trends.yml"
destinations: []
alerts: []
sources:
  - name: dbt_artifacts
    database: staging/local.db
    type: duckdb
    connection_pool_size: 1

models: []
traces:
  - name: model_materialization_distribution
    model: ${ref(model_materializations)}
    props:
      type: pie
      labels: ?{materialization}
      values: ?{count}
      textinfo: label+percent
      hole: .5
      domain:
        column: 0
        row: 0

  - name: top_slow_models
    model: ${ref(slowest_model_runtimes_this_week)}
    props:
      type: bar
      orientation: h
      y: ?{name}
      marker:
        color: ?{CASE WHEN materialization = 'incremental' then '#FFB400' WHEN materialization = 'view' THEN '#003F91'  else '#713B57' end}
      hovertext: ?{materialization}
      hoverinfo: text
      hoverlabel:
        align: right
      text: ?{round(avg_runtime)}
      x: ?{avg_runtime}
    filters:
      - ?{ avg_runtime > 20}
    order_by:
      - ?{ avg_runtime asc }

  - name: test_failures
    model: ${ref(test_executions)}
    cohort_on: status
    props:
      type: scatter
      x: ?{date_trunc('day', run_started_at)::varchar}
      y: ?{SUM(failures)}
      mode: markers

charts:
  - name: Model Materialization Distribution
    layout:
      title:
        text: Distribution of Model Materializations
      margin:
        b: 10
        t: 60
        r: 10
        l: 10
      showlegend: false
      grid:
        rows: 2
        columns: 1
    traces:
      - ${ref(model_materialization_distribution)}

  - name: Top 10 Slowest Models
    layout:
      title:
        text: Top 10 Models by Average Runtime
      xaxis:
        title:
          text: Average Runtime (seconds)
      margin:
        l: 200
        b: 60
        t: 60
        r: 10
    traces:
      - ${ref(top_slow_models)}

  - name: Test Failures Over Time
    layout:
      title:
        text: Test Failures Over Time
      yaxis:
        title:
          text: Number of Failures
    traces:
      - ${ref(test_failures)}


dashboards:
  - name: DBT Performance Overview
    tags: []
    level: 0
    type: internal
    rows:
      - height: compact
        items:
          - markdown: |
              ## High-Level Summary
            align: center
      - height: small
        name: "High-Level Summary"
        items:
          - chart: ${ref(Number of Models in Last Run)}
          - chart: ${ref(total_dbt_build_invocations_this_week_chart)}
          - chart: ${ref(Succesful Invocation Duration Chart)}
          - chart: ${ref(Invocation Success Rate This Week Chart)}
          - chart: ${ref(Number of Tests in Last Run)}
      - height: compact
        items:
          - markdown: |
              ## Run-Level Trends
            align: center
      - height: medium
        name: "Run-Level Trends"
        items:
          - chart: ${ref(Models Over Time)}
          - chart: ${ref(Daily Average Invocation Time)}
          - chart: ${ref(Tests Over Time)}
      - height: compact
        items:
          - markdown: |
              ## Model-Level Diagnostics
            align: center
      - height: large
        name: "Model-Level Diagnostics"
        items:
          - chart: ${ref(Top 10 Slowest Models)}
            width: 2
          - chart: ${ref(Model Materialization Distribution)}
            width: 2
          - markdown: Model Duration Distribution
            justify: center
            align: center

          - markdown: Model Failure Rates
            justify: center
            align: center
      - height: compact
        items:
          - markdown: |
              ## Test & Quality Checks
            align: center
      - height: large
        name: "Test & Quality Checks"
        items:
          - table: 
              name: Test Results This Year
              traces: 
                - name: tests-that-have-failed-in-production
                  model: ${ref(fct_dbt__test_executions)}
                  columns: 
                    "Truncated Id": left(node_id, 40)
                    last_failure_at: max(case when status in ('error', 'fail') THEN QUERY_COMPLETED_AT else null end)::date::varchar
                    test_failures : COUNT(distinct case when status in ('error', 'fail') THEN test_execution_id else null end)
                    test_passes : COUNT(distinct case when status = 'pass' THEN test_execution_id else null end) 
                    test_warnings : COUNT(distinct case when status = 'warn' THEN test_execution_id else null end)
                    test_skips: COUNT(distinct case when status = 'skipped' THEN test_execution_id else null end)
                    "Full ID": node_id 
                  filters: 
                    - ?{year(compile_started_at) = year(current_date)}
                  order_by:
                    - ?{COUNT(distinct case when status in ('error', 'fail') THEN test_execution_id else null end) desc}

        